# 配置管理库架构设计

## 架构概述

采用分层架构设计，基于单例模式（生产模式）和多例模式（测试模式）的混合实例管理策略。

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      应用层                                    │
│                   ConfigManager                              │
│              (单例/多例实例管理)                               │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                     核心层                                    │
│                 ConfigManagerCore                           │
│             (配置管理核心实现)                                │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                    组件层                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  FileOperations │  │ AutosaveManager │  │  FileWatcher    │ │
│  │   (文件操作)     │  │   (自动保存)     │  │   (文件监控)     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  PathResolver   │  │PathConfiguration│  │CrossPlatformPaths│ │
│  │   (路径解析)     │  │   (路径配置)     │  │   (跨平台路径)   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐                     │
│  │ PathsConfigNode │  │DynamicPathProperty│                   │
│  │ (动态路径节点)   │  │  (路径属性描述符)  │                   │
│  └─────────────────┘  └─────────────────┘                     │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. ConfigManager
- **职责**：实例管理、模式切换
- **特点**：生产模式使用基于路径的实例缓存，测试模式使用多例模式

### 2. ConfigManagerCore  
- **职责**：配置管理核心逻辑
- **特点**：继承自ConfigNode，提供完整配置管理功能

### 3. ConfigNode
- **职责**：配置数据容器
- **特点**：支持点语法访问、类型转换、数学运算

### 4. PathsConfigNode
- **职责**：特殊的paths配置节点
- **特点**：支持动态路径生成、路径格式统一化

### 5. DynamicPathProperty
- **职责**：动态路径属性描述符
- **特点**：延迟计算、1秒缓存优化

## 关键设计决策

### 实例管理策略
- **生产模式**：基于配置文件路径的实例缓存，避免重复实例化
- **测试模式**：多例模式，确保测试环境隔离

### 模块化设计
- 每个功能模块独立实现
- 通过依赖注入降低耦合度
- 支持延迟初始化提高性能

### 异步处理
- 自动保存使用定时器异步执行
- 文件监控使用独立线程
- 避免阻塞主线程

## 技术选型

- **语言**：Python 3.12+
- **配置格式**：YAML (ruamel.yaml)
- **线程安全**：threading模块
- **路径处理**：pathlib + os.path
- **日志记录**：自定义最小化日志器