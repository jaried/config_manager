# 测试模式功能需求规格说明书 (PRD)

## 1. 需求概述

### 1.1 需求背景
在开发和测试过程中，需要创建与生产环境完全隔离的测试环境，避免测试操作影响生产配置和数据。测试模式功能需要提供简单有效的环境隔离机制。

### 1.2 核心需求
- **环境隔离**：创建与生产环境完全隔离的测试环境
- **简化逻辑**：只设置`base_dir`为测试环境路径，移除复杂的递归路径替换
- **自动路径生成**：基于测试`base_dir`自动生成其他路径
- **配置复制**：将生产配置复制到测试环境
- **向后兼容**：保持与现有配置管理器的兼容性

### 1.3 业务价值
- **提高开发效率**：快速创建隔离的测试环境
- **降低风险**：避免测试操作影响生产环境
- **简化操作**：简化的测试环境创建逻辑
- **支持团队协作**：团队成员可以安全地进行测试

## 2. 功能需求

### 2.1 测试环境创建功能
- **需求描述**：创建与生产环境完全隔离的测试环境
- **实现方式**：
  - 复制生产配置文件到测试环境
  - 设置`base_dir`为测试环境路径
  - 调用`setup_project_paths()`生成其他路径
- **验收标准**：
  - 测试环境与生产环境完全隔离
  - 所有路径都基于测试环境生成
  - 配置文件正确复制和更新

### 2.2 配置复制功能
- **需求描述**：将生产配置复制到测试环境
- **实现方式**：
  - 加载源配置文件
  - 复制配置数据到测试环境
  - 更新`config_file_path`为测试路径
- **验收标准**：
  - 配置数据完整复制
  - `config_file_path`正确更新
  - 支持标准格式和原始格式

### 2.3 base_dir设置功能
- **需求描述**：设置测试环境的`base_dir`
- **实现方式**：
  - 获取测试配置文件所在目录
  - 将`base_dir`设置为测试目录
  - 支持多平台路径格式
- **验收标准**：
  - `base_dir`正确设置为测试路径
  - 支持Windows和Ubuntu路径格式
  - 路径格式正确

### 2.4 自动路径生成功能
- **需求描述**：基于测试`base_dir`自动生成其他路径
- **实现方式**：
  - 调用`setup_project_paths()`方法
  - 基于测试`base_dir`生成工作目录
  - 生成检查点、日志等子目录
- **验收标准**：
  - 所有路径都基于测试`base_dir`生成
  - 路径结构正确
  - 支持调试模式路径调整

### 2.5 自动目录创建功能
- **需求描述**：自动创建测试环境所需的目录
- **实现方式**：
  - 仅对`_dir`结尾字段自动创建目录
  - 递归处理ConfigNode和dict类型
  - 创建失败时记录警告但不中断程序
- **验收标准**：
  - 所有`_dir`结尾字段的目录都被创建
  - 创建失败时不影响程序运行
  - 测试环境立即可用

## 3. 非功能需求

### 3.1 性能要求
- **响应时间**：测试环境创建应在秒级完成
- **内存使用**：不应显著增加内存占用
- **缓存机制**：支持路径生成结果的缓存

### 3.2 兼容性要求
- **Python版本**：支持Python 3.8+
- **操作系统**：Windows 10+、Ubuntu
- **现有代码**：100%向后兼容现有配置管理器API

### 3.3 可维护性要求
- **代码结构**：模块化设计，便于维护
- **错误处理**：完善的异常处理机制
- **日志记录**：关键操作需要记录日志

### 3.4 可扩展性要求
- **新功能支持**：能够方便地添加新的测试功能
- **配置格式扩展**：支持更复杂的配置格式
- **路径类型扩展**：支持更多类型的路径配置

## 4. 用户故事

### 4.1 用户故事1：开发者的测试需求
**作为** 一个开发者  
**我希望** 能够快速创建隔离的测试环境  
**以便** 我可以在不影响生产环境的情况下进行测试

**验收标准**：
- 通过`test_mode=True`参数快速创建测试环境
- 测试环境与生产环境完全隔离
- 所有路径都基于测试环境生成

### 4.2 用户故事2：团队协作的测试需求
**作为** 一个团队成员  
**我希望** 团队成员都能安全地进行测试  
**以便** 我们不会相互影响各自的测试环境

**验收标准**：
- 每个测试环境都有唯一的路径
- 测试环境之间相互隔离
- 测试操作不会影响其他环境

### 4.3 用户故事3：现有项目的测试需求
**作为** 一个现有项目的维护者  
**我希望** 现有的配置能够继续正常工作  
**以便** 我能够在不破坏现有功能的情况下使用测试模式

**验收标准**：
- 现有配置文件能够继续正常工作
- 测试模式是可选的，不影响现有行为
- 升级过程无需手动修改配置

## 5. 验收标准

### 5.1 功能验收
- [x] 能够正确创建测试环境
- [x] 配置能够正确复制到测试环境
- [x] base_dir能够正确设置为测试路径
- [x] 其他路径能够基于测试base_dir自动生成
- [x] 测试环境与生产环境完全隔离
- [x] 自动目录创建功能正常工作

### 5.2 测试验收
- [x] 单元测试覆盖率达到90%以上
- [x] 集成测试验证测试环境创建
- [x] 跨平台兼容性测试通过
- [x] 性能测试满足要求

### 5.3 文档验收
- [x] 完整的API文档
- [x] 使用示例和最佳实践
- [x] 架构设计文档更新
- [x] 测试用例文档

## 6. 风险评估

### 6.1 技术风险
- **路径冲突**：多个测试环境可能产生路径冲突
- **权限问题**：测试目录创建权限不足
- **配置损坏**：测试过程中可能损坏配置文件

### 6.2 缓解措施
- 使用时间戳生成唯一路径
- 提供权限检查和错误处理
- 实现配置备份和恢复机制

## 7. 实施计划

### 7.1 开发阶段
1. **需求分析**：完成需求文档编写和评审 ✅
2. **架构设计**：设计测试模式架构 ✅
3. **详细设计**：设计具体的实现方案 ✅
4. **代码实现**：实现测试模式功能 ✅
5. **测试验证**：编写和执行测试用例 ✅
6. **文档完善**：更新相关文档 ✅

### 7.2 时间安排
- 需求分析：1天 ✅
- 架构设计：1天 ✅
- 详细设计：1天 ✅
- 代码实现：2天 ✅
- 测试验证：2天 ✅
- 文档完善：1天 ✅

总计：8天 ✅

## 8. 任务完成状态

### 8.1 已完成任务
- ✅ **任务6**：简化`test_mode`逻辑 - 移除复杂递归路径替换，只设置`base_dir`

### 8.2 实现细节
- **简化逻辑**：只设置base_dir，移除复杂的递归路径替换
- **自动路径生成**：基于测试base_dir自动生成其他路径
- **完全隔离**：测试环境与生产环境完全分离
- **向后兼容**：保持与现有配置管理器的兼容性

## 9. 附录

### 9.1 术语定义
- **测试模式**：创建隔离测试环境的模式
- **环境隔离**：测试环境与生产环境的完全分离
- **配置复制**：将生产配置复制到测试环境的过程
- **自动路径生成**：基于base_dir自动生成其他路径的过程

### 9.2 参考文档
- 路径配置模块需求文档
- 配置管理器架构设计文档
- 测试模式路径替换设计文档
