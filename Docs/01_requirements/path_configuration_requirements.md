# 路径配置模块需求分析文档 (PRD)

## 1. 需求概述

### 1.1 需求背景
为了支持机器学习项目的标准化路径管理，需要在配置管理器中增加路径配置模块，提供统一的路径配置方案，支持调试模式和生产模式的路径隔离。

### 1.2 核心需求
- 集成is_debug模块，自动检测调试模式
- 提供标准化的路径配置结构
- 支持基于调试模式的路径隔离
- 自动生成基于时间的日志目录结构
- 提供检查点和最佳模型的存储路径管理
- `config.debug_mode`属性应该动态返回`is_debug()`函数的结果

## 2. 功能需求

### 2.1 调试模式动态检测
- **需求描述**：`config.debug_mode`属性应该动态返回`is_debug()`函数的结果
- **实现方式**：
  - 通过ConfigNode的`__getattr__`方法特殊处理`debug_mode`属性
  - 访问时自动调用`is_debug()`函数
  - 不在配置文件中存储`debug_mode`值
- **预期效果**：
  - `config.debug_mode`始终反映当前运行环境的调试状态
  - 如果`is_debug`模块不可用，默认返回`False`（生产模式）
  - 配置文件中不包含`debug_mode`字段

### 2.2 基础路径配置
- **需求描述**：设置项目的基础存储路径
- **配置项**：
  - `config.base_dir = 'd:\logs'`（Windows环境）
- **要求**：支持跨平台路径格式

### 2.3 工作目录配置
- **需求描述**：基于项目名称和实验名称生成工作目录
- **路径结构**：
  ```
  config.paths.work_dir = config.base_dir/{debug标识}/config.project_name/config.experiment_name
  ```
- **调试模式处理**：
  - 调试模式：`base_dir/debug/project_name/experiment_name`
  - 生产模式：`base_dir/project_name/experiment_name`

### 2.4 检查点目录配置
- **需求描述**：为模型检查点提供标准化存储路径
- **配置项**：
  - `config.paths.checkpoint_dir = config.paths.work_dir/checkpoint/`
  - `config.paths.best_checkpoint_dir = config.paths.work_dir/checkpoint/best`
- **用途**：存储训练过程中的模型检查点和最佳模型

### 2.5 调试目录配置
- **需求描述**：为调试相关文件提供专用存储目录
- **配置项**：
  - `config.paths.debug_dir = config.paths.work_dir/debug/`
- **用途**：存储调试过程中的临时文件、调试日志、测试数据等

### 2.6 日志目录配置
- **需求描述**：基于启动时间生成日志目录结构
- **配置项**：
  - `config.paths.tsb_logs_dir = config.paths.work_dir/tsb_logs/{日期}/{时间}`
  - `config.paths.log_dir = config.paths.work_dir/logs/{日期}/{时间}`
- **时间格式**：
  - 日期：YYYY-MM-DD格式
  - 时间：HHMMSS格式
- **时间来源**：`config.first_start_time`

### 2.7 自动目录创建
- **需求描述**：在路径配置赋值时自动创建对应的目录结构
- **实现要求**：
  - 当设置paths相关配置时，自动检查并创建目录
  - 支持递归创建父目录（parents=True）
  - 目录已存在时不报错（exist_ok=True）
  - 创建失败时记录警告但不中断程序
  - 测试模式下同样自动创建目录
  - 路径配置管理器生成路径时自动创建目录
- **适用范围**：
  - 所有paths命名空间下的路径配置
  - 路径配置管理器生成的所有路径
  - 测试模式和生产模式均适用
- **预期效果**：外部模块访问路径时目录已存在，避免FileNotFoundError

## 3. 技术需求

### 3.1 依赖模块
- **is_debug模块**：提供调试模式检测功能
- **ruamel.yaml**：配置文件处理（已有）
- **pathlib/os.path**：路径操作支持

### 3.2 配置字段定义
```yaml
# 注意：debug_mode不在配置文件中存储，而是动态属性

# 基础路径配置
base_dir: 'd:\logs'  # 基础存储路径

# 项目配置
project_name: 'my_project'  # 项目名称
experiment_name: 'exp_001'  # 实验名称

# 时间配置
first_start_time: '2025-01-08T10:00:00'  # 首次启动时间

# 自动生成的路径配置（通过config.paths.xxx访问）
paths:
  work_dir: ''  # 工作目录
  checkpoint_dir: ''  # 检查点目录
  best_checkpoint_dir: ''  # 最佳检查点目录
  debug_dir: ''  # 调试目录
  tsb_logs_dir: ''  # TensorBoard日志目录
  log_dir: ''  # 普通日志目录
```

### 3.3 路径生成规则
1. **调试模式检测**：`debug_mode = is_debug()`
2. **工作目录生成**：
   ```python
   if debug_mode:
       work_dir = f"{base_dir}/debug/{project_name}/{experiment_name}"
   else:
       work_dir = f"{base_dir}/{project_name}/{experiment_name}"
   ```
3. **时间解析**：从`first_start_time`提取日期和时间
4. **子目录生成**：基于work_dir生成各种子目录

## 4. 非功能需求

### 4.1 性能要求
- 路径生成操作应在毫秒级完成
- 支持配置缓存，避免重复计算

### 4.2 兼容性要求
- 支持Windows、Linux、macOS路径格式
- 兼容现有配置管理器架构
- 向后兼容现有配置文件

### 4.3 可维护性要求
- 路径生成逻辑应模块化
- 提供清晰的配置项文档
- 支持路径配置的验证和测试

## 5. 验收标准

### 5.1 功能验收
- [x] 能够正确检测调试模式
- [x] 能够生成正确的工作目录路径
- [x] 能够基于时间生成日志目录
- [x] 能够创建所有必需的子目录
- [x] 路径配置能够正确保存和加载
- [x] 设置路径配置时自动创建对应目录
- [x] 外部模块访问config.paths.log_dir等路径时目录已存在
- [x] 测试模式下路径自动创建功能正常工作
- [x] 路径配置管理器生成的所有路径都能自动创建
- [x] 能够自动生成debug_dir目录配置

### 5.2 测试验收
- [ ] 单元测试覆盖率达到90%以上
- [ ] 集成测试验证路径生成逻辑
- [ ] 跨平台兼容性测试通过
- [ ] 调试/生产模式切换测试通过

### 5.3 文档验收
- [ ] 完整的API文档
- [ ] 配置项说明文档
- [ ] 使用示例和最佳实践
- [ ] 架构设计文档更新

## 6. 风险评估

### 6.1 技术风险
- **路径格式兼容性**：不同操作系统的路径格式差异
- **权限问题**：目录创建权限不足
- **时间解析**：时间格式解析错误

### 6.2 缓解措施
- 使用pathlib进行跨平台路径处理
- 提供权限检查和错误处理
- 严格验证时间格式和解析逻辑

## 7. 实施计划

### 7.1 开发阶段
1. **需求分析**：完成需求文档编写
2. **架构设计**：更新架构设计文档
3. **详细设计**：编写路径配置模块设计文档
4. **代码实现**：实现路径配置功能
5. **测试验证**：编写和执行测试用例
6. **文档完善**：更新相关文档

### 7.2 时间安排
- 需求分析：1天
- 架构设计：1天
- 详细设计：1天
- 代码实现：2天
- 测试验证：2天
- 文档完善：1天

总计：8天

## 8. 附录

### 8.1 相关文档
- 《配置管理器架构设计文档》
- 《测试模式路径替换设计文档》
- 《is_debug模块使用说明》

### 8.2 术语定义
- **调试模式**：开发和调试阶段的运行模式
- **生产模式**：正式运行环境的模式
- **工作目录**：项目运行时的主要工作路径
- **检查点**：模型训练过程中保存的中间状态
- **实验名称**：区分不同实验配置的标识符 