# 移除默认值任务清单

本文档详细列出了`config-manager`项目中需要移除默认值的任务。每个任务都包含需要审查和修改的各个环节，以确保重构的完整性和质量。

---

### **全局重构原则**

在执行以下所有任务时，必须严格遵守以下核心原则：

1. **禁止默认值**: 禁止在代码中使用默认值，所有配置项必须在配置文件中显式定义。
2. **错误穿透**: 当配置项缺失时，应让错误自然抛出，不提供默认值。
3. **配置完整性**: 配置文件模板必须包含所有必需的配置项，不依赖代码中的默认值。
4. **显式配置**: 所有配置项必须在配置文件中明确定义，不允许代码中的隐式默认值。

---

### **任务1：优化其他项目的频繁备份、保存、加载问题**

**目标**: 解决其他项目（如bakamh）使用config_manager时出现的频繁备份、保存、加载问题。

**问题描述**: 
从日志分析发现，其他项目在使用config_manager时出现以下问题：
1. **频繁的自动备份**：每处理一本漫画就备份一次配置
2. **频繁的自动保存**：每处理一本漫画就保存一次配置  
3. **频繁的重新加载**：每处理一本漫画就重新加载配置

**根本原因分析**:
1. **路径配置频繁生成**：`PathConfigurationManager` 在 `setup_project_paths()` 中会生成大量路径配置项
2. **路径配置自动保存**：每次路径生成都会触发配置保存，导致文件变化
3. **文件监视触发重载**：每次保存都触发文件监视器，导致重新加载
4. **其他项目频繁调用路径设置**：其他项目可能在每次处理时都调用路径相关设置

**真正的问题**：
- 配置文件频繁变化是因为路径配置的频繁生成和保存
- 每次调用 `setup_project_paths()` 都会生成新的路径配置并保存
- 其他项目可能在每次处理任务时都重新设置路径配置

**已发现的Bug**：
- **`get_config_manager()` 函数设计缺陷**：每次调用都会执行 `setup_project_paths()`，即使返回的是同一个单例实例
- **单例模式失效**：虽然返回同一个实例，但每次都会重复初始化路径配置
- **重复执行导致频繁保存**：每次重复执行都会触发配置保存和备份

**Bug修复方案**：
- 在 `get_config_manager()` 函数中添加 `_paths_initialized` 标志
- 只在首次创建实例时执行 `setup_project_paths()`
- 避免对同一个实例重复执行路径配置初始化

**彻底解决方案：全局单例模式**
- **问题根源**：当前基于配置路径的多例模式导致不同参数创建不同实例
- **解决方案**：改为全局单例模式，只允许一个实例存在
- **优势**：
  - 彻底避免多例问题
  - 简化实例管理
  - 确保配置一致性
  - 减少内存占用
- **特殊处理**：
  - 测试模式时清理现有实例
  - 参数不一致时发出警告但返回现有实例
  - 保持向后兼容性

- **[ ] 需求确认**: 
    - 分析其他项目的使用场景，确定路径配置的合理调用频率
    - 优化路径配置生成机制，避免不必要的重复生成
    - 优化文件监视机制，避免内部保存时触发重新加载
    - 优化备份策略，减少不必要的备份
- **[ ] 架构设计**:
    - **修改确认**: 更新架构图，优化路径配置生成和自动保存流程
    - **文档更新**: `Docs/02_architecture/architecture_design.md`
- **[ ] 概要设计**:
    - **修改确认**: 更新路径配置管理和自动保存的设计说明
    - **文档更新**: 相关的概要设计文档
- **[ ] 详细设计**:
    - **修改确认**: 详细描述优化后的路径配置生成和保存机制
    - **文档更新**: 相关的详细设计文档
- **[ ] 代码实现**:
    - **修改确认**:
        - ✅ **实现全局单例模式**：将 `_instances` 字典改为 `_instance` 单一实例
        - ✅ **修复 `get_config_manager()` 函数**：添加参数一致性检查和测试模式处理
        - ✅ **删除缓存键生成逻辑**：不再需要基于路径的缓存键
        - ✅ **更新清理和调试方法**：适配全局单例模式
        - 优化 `PathConfigurationManager` 的路径生成逻辑，避免重复生成
        - 添加路径配置缓存机制，避免重复计算
        - 优化 `setup_project_paths()` 方法，减少不必要的保存
        - 优化文件监视机制，避免内部保存时触发重新加载
        - 添加配置项来控制路径配置的更新频率
    - **涉及文件**: 
        - ✅ `src/config_manager/config_manager.py` - 已修复
        - `src/config_manager/core/path_configuration.py`
        - `src/config_manager/core/manager.py`
        - `src/config_manager/core/file_watcher.py`
        - `src/config_manager/core/file_operations.py`
- **[ ] 测试用例**:
    - **修改确认**: 
        - 添加测试用例，验证全局单例模式的正确性
        - 添加测试用例，验证 `get_config_manager()` 的修复效果
        - 添加测试用例，验证路径配置的优化效果
        - 验证文件监视的优化效果
        - 验证备份策略的优化效果
    - **涉及文件**: `tests/` 目录下的相关测试文件
- **[ ] 测试通过状态**: (待执行)

---

### **任务2：测试用例调用get_config_manager时增加test_mode=True参数**

**目标**: 确保所有涉及ConfigManager多例/隔离行为的测试用例均显式传递test_mode=True参数，保证测试环境下实例隔离，避免单例污染。

- **[x] 需求确认**: 
    - 检查所有涉及ConfigManager多例/隔离行为的测试用例。
    - 在所有测试用例中，调用get_config_manager时都显式增加test_mode=True参数。
- **[x] 代码实现**:
    - 修改tests/test_config_manager/test_tc0006_singleton_path_resolution.py等相关测试文件，所有get_config_manager调用均加test_mode=True。
    - 复查所有相关测试用例，确保无遗漏。
- **[x] 测试用例**:
    - 运行全部相关测试，确保通过。
    - 补充说明：需全面复查所有测试用例，防止遗漏未加test_mode=True的情况。
- **[x] 影响范围**:
    - 只影响测试代码，不影响生产逻辑。
    - 测试用例更健壮，避免单例污染，便于后续维护。
- **[x] 风险提示**:
    - 若有遗漏，部分测试仍可能因单例污染而失败。
    - 建议后续新测试用例也遵循此规范。
- **[x] 当前状态**: 已完成主要修改（已批量修改并通过部分测试，发现测试用例期望与实际实现不匹配的问题，需要进一步调整测试用例的期望值）。 