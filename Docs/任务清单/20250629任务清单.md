# 移除默认值任务清单

本文档详细列出了`config-manager`项目中需要移除默认值的任务。每个任务都包含需要审查和修改的各个环节，以确保重构的完整性和质量。

---

### **全局重构原则**

在执行以下所有任务时，必须严格遵守以下核心原则：

1. **禁止默认值**: 禁止在代码中使用默认值，所有配置项必须在配置文件中显式定义。
2. **错误穿透**: 当配置项缺失时，应让错误自然抛出，不提供默认值。
3. **配置完整性**: 配置文件模板必须包含所有必需的配置项，不依赖代码中的默认值。
4. **显式配置**: 所有配置项必须在配置文件中明确定义，不允许代码中的隐式默认值。

---

### **任务1：移除 PathConfigurationManager 中的默认值**

**目标**: 移除 `PathConfigurationManager` 类中的所有默认值设置。

- **[ ] 需求确认**: 
    - 移除 `DEFAULT_PATH_CONFIG` 字典
    - 移除 `_set_default_values()` 方法中的默认值设置
    - 修改 `_generate_paths_internal()` 方法，移除默认值逻辑
- **[ ] 架构设计**:
    - **修改确认**: 更新架构图，移除默认值相关的流程
    - **文档更新**: `Docs/02_architecture/architecture_design.md`
- **[ ] 概要设计**:
    - **修改确认**: 更新 `PathConfigurationManager` 的职责描述，移除默认值设置的职责
    - **文档更新**: 相关的概要设计文档
- **[ ] 详细设计**:
    - **修改确认**: 详细描述如何处理配置项缺失的情况
    - **文档更新**: 相关的详细设计文档
- **[ ] 代码实现**:
    - **修改确认**:
        - 删除 `DEFAULT_PATH_CONFIG` 字典
        - 修改 `_set_default_values()` 方法，改为只进行配置项存在性检查
        - 修改 `_generate_paths_internal()`，移除所有默认值赋值
        - 修改 `get_path_info()`，移除默认值逻辑
    - **涉及文件**: `src/config_manager/core/path_configuration.py`
- **[ ] 测试用例**:
    - **修改确认**: 
        - 更新测试用例，验证配置项缺失时会抛出适当的异常
        - 确保测试配置文件包含所有必需的配置项
    - **涉及文件**: `tests/` 目录下的相关测试文件
- **[ ] 测试通过状态**: (待执行)

---

### **任务2：移除 CrossPlatformPathManager 中的默认值**

**目标**: 移除 `CrossPlatformPathManager` 类中的所有默认值设置。

- **[ ] 需求确认**: 
    - 移除 `DEFAULT_PATHS` 字典
    - 修改 `get_default_path()` 方法的行为
    - 修改 `get_platform_path()` 方法，移除默认值逻辑
- **[ ] 架构设计**:
    - **修改确认**: 更新架构图，移除默认路径相关的流程
    - **文档更新**: `Docs/02_architecture/architecture_design.md`
- **[ ] 概要设计**:
    - **修改确认**: 更新 `CrossPlatformPathManager` 的职责描述
    - **文档更新**: 相关的概要设计文档
- **[ ] 详细设计**:
    - **修改确认**: 详细描述如何处理路径配置缺失的情况
    - **文档更新**: 相关的详细设计文档
- **[ ] 代码实现**:
    - **修改确认**:
        - 删除 `DEFAULT_PATHS` 字典
        - 修改 `get_default_path()` 方法，改为抛出异常
        - 修改 `get_platform_path()`，移除默认值逻辑
    - **涉及文件**: `src/config_manager/core/cross_platform_paths.py`
- **[ ] 测试用例**:
    - **修改确认**: 
        - 更新测试用例，验证路径配置缺失时会抛出适当的异常
        - 确保测试配置文件包含所有必需的路径配置
    - **涉及文件**: `tests/` 目录下的相关测试文件
- **[ ] 测试通过状态**: (待执行)

---

### **任务3：移除 ConfigManager 中的默认值**

**目标**: 移除 `ConfigManager` 类中的所有默认值设置。

- **[ ] 需求确认**: 
    - 修改 `get()` 方法，移除默认值参数
    - 修改配置文件创建逻辑，确保包含所有必需配置项
- **[ ] 架构设计**:
    - **修改确认**: 更新架构图，移除默认值相关的流程
    - **文档更新**: `Docs/02_architecture/architecture_design.md`
- **[ ] 概要设计**:
    - **修改确认**: 更新 `ConfigManager` 的职责描述
    - **文档更新**: 相关的概要设计文档
- **[ ] 详细设计**:
    - **修改确认**: 详细描述如何处理配置项缺失的情况
    - **文档更新**: 相关的详细设计文档
- **[ ] 代码实现**:
    - **修改确认**:
        - 修改 `get()` 方法，移除 `default` 参数
        - 更新配置文件创建逻辑，确保生成完整的配置模板
    - **涉及文件**: `src/config_manager/config_manager.py`
- **[ ] 测试用例**:
    - **修改确认**: 
        - 更新测试用例，验证配置项缺失时会抛出适当的异常
        - 确保测试配置文件包含所有必需的配置项
    - **涉及文件**: `tests/` 目录下的相关测试文件
- **[ ] 测试通过状态**: (待执行)

---

### **任务4：更新配置文件模板**

**目标**: 确保配置文件模板包含所有必需的配置项，不依赖代码中的默认值。

- **[ ] 需求确认**: 
    - 识别所有必需的配置项
    - 创建完整的配置文件模板
    - 更新配置文件文档
- **[ ] 架构设计**:
    - **修改确认**: 更新架构图，添加配置文件模板的说明
    - **文档更新**: `Docs/02_architecture/architecture_design.md`
- **[ ] 概要设计**:
    - **修改确认**: 添加配置文件模板的设计说明
    - **文档更新**: 相关的概要设计文档
- **[ ] 详细设计**:
    - **修改确认**: 详细列出所有必需的配置项及其格式
    - **文档更新**: 相关的详细设计文档
- **[ ] 代码实现**:
    - **修改确认**:
        - 创建完整的配置文件模板
        - 更新配置文件创建逻辑
    - **涉及文件**: 
        - `src/config/config.yaml`
        - `src/config_manager/config_manager.py`
- **[ ] 测试用例**:
    - **修改确认**: 
        - 添加测试用例，验证配置文件模板的完整性
        - 验证配置文件创建逻辑
    - **涉及文件**: `tests/` 目录下的相关测试文件
- **[ ] 测试通过状态**: (待执行)

---

### **任务5：更新文档和示例**

**目标**: 更新所有文档和示例代码，反映移除默认值后的新行为。

- **[ ] 需求确认**: 
    - 更新所有文档中关于配置项的说明
    - 更新示例代码，展示正确的配置使用方式
- **[ ] 文档更新**:
    - **修改确认**:
        - 更新 README.md
        - 更新架构设计文档
        - 更新概要设计文档
        - 更新详细设计文档
        - 更新用户指南
    - **涉及文件**: `docs/` 目录下的所有相关文档
- **[ ] 示例代码更新**:
    - **修改确认**:
        - 更新所有示例代码
        - 确保示例中包含完整的配置文件
    - **涉及文件**: `src/demo/` 目录下的所有示例文件
- **[ ] 测试通过状态**: (待执行)

---

### **任务6：配置验证增强**

**目标**: 增强配置验证机制，确保所有必需的配置项都存在。

- **[ ] 需求确认**: 
    - 实现配置完整性检查
    - 提供清晰的错误信息
- **[ ] 架构设计**:
    - **修改确认**: 更新架构图，添加配置验证流程
    - **文档更新**: `Docs/02_architecture/architecture_design.md`
- **[ ] 概要设计**:
    - **修改确认**: 添加配置验证机制的设计说明
    - **文档更新**: 相关的概要设计文档
- **[ ] 详细设计**:
    - **修改确认**: 详细描述配置验证的实现方式
    - **文档更新**: 相关的详细设计文档
- **[ ] 代码实现**:
    - **修改确认**:
        - 实现配置完整性检查机制
        - 添加详细的错误信息
    - **涉及文件**: 
        - `src/config_manager/config_manager.py`
        - `src/config_manager/core/validation.py`
- **[ ] 测试用例**:
    - **修改确认**: 
        - 添加配置验证的测试用例
        - 验证错误信息的准确性
    - **涉及文件**: `tests/` 目录下的相关测试文件
- **[ ] 测试通过状态**: (待执行)

---

### **任务7：优化其他项目的频繁备份、保存、加载问题**

**目标**: 解决其他项目（如bakamh）使用config_manager时出现的频繁备份、保存、加载问题。

**问题描述**: 
从日志分析发现，其他项目在使用config_manager时出现以下问题：
1. **频繁的自动备份**：每处理一本漫画就备份一次配置
2. **频繁的自动保存**：每处理一本漫画就保存一次配置  
3. **频繁的重新加载**：每处理一本漫画就重新加载配置

**根本原因分析**:
1. **路径配置频繁生成**：`PathConfigurationManager` 在 `setup_project_paths()` 中会生成大量路径配置项
2. **路径配置自动保存**：每次路径生成都会触发配置保存，导致文件变化
3. **文件监视触发重载**：每次保存都触发文件监视器，导致重新加载
4. **其他项目频繁调用路径设置**：其他项目可能在每次处理时都调用路径相关设置

**真正的问题**：
- 配置文件频繁变化是因为路径配置的频繁生成和保存
- 每次调用 `setup_project_paths()` 都会生成新的路径配置并保存
- 其他项目可能在每次处理任务时都重新设置路径配置

- **[ ] 需求确认**: 
    - 分析其他项目的使用场景，确定路径配置的合理调用频率
    - 优化路径配置生成机制，避免不必要的重复生成
    - 优化文件监视机制，避免内部保存时触发重新加载
    - 优化备份策略，减少不必要的备份
- **[ ] 架构设计**:
    - **修改确认**: 更新架构图，优化路径配置生成和自动保存流程
    - **文档更新**: `Docs/02_architecture/architecture_design.md`
- **[ ] 概要设计**:
    - **修改确认**: 更新路径配置管理和自动保存的设计说明
    - **文档更新**: 相关的概要设计文档
- **[ ] 详细设计**:
    - **修改确认**: 详细描述优化后的路径配置生成和保存机制
    - **文档更新**: 相关的详细设计文档
- **[ ] 代码实现**:
    - **修改确认**:
        - 优化 `PathConfigurationManager` 的路径生成逻辑，避免重复生成
        - 添加路径配置缓存机制，避免重复计算
        - 优化 `setup_project_paths()` 方法，减少不必要的保存
        - 优化文件监视机制，避免内部保存时触发重新加载
        - 添加配置项来控制路径配置的更新频率
    - **涉及文件**: 
        - `src/config_manager/core/path_configuration.py`
        - `src/config_manager/core/manager.py`
        - `src/config_manager/core/file_watcher.py`
        - `src/config_manager/core/file_operations.py`
- **[ ] 测试用例**:
    - **修改确认**: 
        - 添加测试用例，验证路径配置的优化效果
        - 验证文件监视的优化效果
        - 验证备份策略的优化效果
    - **涉及文件**: `tests/` 目录下的相关测试文件
- **[ ] 测试通过状态**: (待执行) 